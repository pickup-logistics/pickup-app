// Pick Up - Database Schema
// Phase 2: Complete Prisma Schema Design

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER MODELS
// ============================================

enum UserRole {
  USER
  RIDER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id        String     @id @default(cuid())
  phone     String     @unique
  name      String
  email     String?    @unique
  password  String?    // For future email/password login
  role      UserRole   @default(USER)
  status    UserStatus @default(ACTIVE)
  transactions    Transaction[]
  
  // Profile
  avatar          String?
  dateOfBirth     DateTime?
  gender          String?
  address         String?
  
  // Bank Account
  bankName        String?
  accountNumber   String?
  accountName     String?
  bankCode        String?
  accountReference String?
  
  // Verification
  isPhoneVerified Boolean   @default(false)
  isEmailVerified Boolean   @default(false)
  
  // Relationships
  rider           Rider?
  ridesAsUser     Ride[]    @relation("UserRides")
  ratingsGiven    Rating[]  @relation("RatingsGiven")
  ratingsReceived Rating[]  @relation("RatingsReceived")
  wallet          Wallet?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?

  @@index([phone])
  @@index([email])
  @@index([status])
  @@map("users")
}

// ============================================
// RIDER MODELS
// ============================================

enum RiderStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
  INACTIVE
}

enum VehicleType {
  BIKE
  TRICYCLE
  BUS
  TRUCK
}

model Rider {
  id     String       @id @default(cuid())
  userId String       @unique
  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Vehicle Information
  vehicleType        VehicleType
  vehicleMake        String?
  vehicleModel       String?
  vehicleYear        Int?
  vehicleColor       String?
  plateNumber        String        @unique
  
  // Documents
  licenseNumber      String        @unique
  licenseExpiryDate  DateTime?
  insuranceNumber    String?
  insuranceExpiryDate DateTime?
  vehiclePhoto       String?
  licensePhoto       String?
  
  // Status & Verification
  status             RiderStatus   @default(PENDING)
  isAvailable        Boolean       @default(false)
  isOnline           Boolean       @default(false)
  
  // Location (current)
  currentLatitude    Float?
  currentLongitude   Float?
  lastLocationUpdate DateTime?
  
  // Statistics
  totalRides         Int           @default(0)
  completedRides     Int           @default(0)
  cancelledRides     Int           @default(0)
  rating             Float         @default(0)
  totalEarnings      Float         @default(0)
  
  // Company (if rider belongs to a company)
  companyId          String?
  company            Company?      @relation(fields: [companyId], references: [id])
  
  // Relationships
  rides              Ride[]
  
  // Timestamps
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  approvedAt         DateTime?
  
  @@index([userId])
  @@index([status])
  @@index([isAvailable])
  @@index([vehicleType])
  @@index([companyId])
  @@index([plateNumber])
  @@map("riders")
}

// ============================================
// RIDE MODELS
// ============================================

enum RideStatus {
  PENDING
  ACCEPTED
  ARRIVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  WALLET
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Ride {
  id       String      @id @default(cuid())
  transactions    Transaction[]
  
  // Participants
  userId   String
  user     User        @relation("UserRides", fields: [userId], references: [id])
  riderId  String?
  rider    Rider?      @relation(fields: [riderId], references: [id])
  
  // Location Information
  pickupLatitude     Float
  pickupLongitude    Float
  pickupAddress      String
  dropoffLatitude    Float
  dropoffLongitude   Float
  dropoffAddress     String
  
  // Ride Details
  vehicleType        VehicleType
  status             RideStatus      @default(PENDING)
  distance           Float?          // in kilometers
  duration           Int?            // in minutes
  
  // Pricing
  baseFare           Float
  perKmRate          Float
  totalFare          Float
  promoDiscount      Float           @default(0)
  finalFare          Float
  
  // Payment
  paymentMethod      PaymentMethod   @default(CASH)
  paymentStatus      PaymentStatus   @default(PENDING)
  
  // Additional Info
  notes              String?         // User notes for rider
  cancellationReason String?
  cancelledBy        String?         // userId or riderId
  
  // Ratings
  rating             Rating?
  
  // Timestamps
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  acceptedAt         DateTime?
  arrivedAt          DateTime?
  startedAt          DateTime?
  completedAt        DateTime?
  cancelledAt        DateTime?
  
  @@index([userId])
  @@index([riderId])
  @@index([status])
  @@index([createdAt])
  @@index([vehicleType])
  @@map("rides")
}

// ============================================
// RATING MODEL
// ============================================

model Rating {
  id          String   @id @default(cuid())
  
  // Ride relationship
  rideId      String   @unique
  ride        Ride     @relation(fields: [rideId], references: [id], onDelete: Cascade)
  
  // Who rated whom
  fromUserId  String
  fromUser    User     @relation("RatingsGiven", fields: [fromUserId], references: [id])
  toUserId    String
  toUser      User     @relation("RatingsReceived", fields: [toUserId], references: [id])
  
  // Rating details
  rating      Int      // 1-5 stars
  comment     String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  @@index([rideId])
  @@index([fromUserId])
  @@index([toUserId])
  @@map("ratings")
}

// ============================================
// COMPANY MODEL (For fleet management)
// ============================================

enum CompanyStatus {
  PENDING
  APPROVED
  SUSPENDED
  INACTIVE
}

model Company {
  id                  String        @id @default(cuid())
  
  // Company Information
  name                String
  registrationNumber  String        @unique
  email               String        @unique
  phone               String        @unique
  
  // Address
  address             String
  city                String
  state               String
  country             String        @default("Nigeria")
  
  // Contact Person
  contactPersonName   String
  contactPersonPhone  String
  contactPersonEmail  String?
  
  // Documents
  cacDocument         String?       // Certificate of Incorporation
  taxIdNumber         String?
  
  // Status
  status              CompanyStatus @default(PENDING)
  
  // Relationships
  riders              Rider[]
  
  // Statistics
  totalRiders         Int           @default(0)
  activeRiders        Int           @default(0)
  totalRides          Int           @default(0)
  totalRevenue        Float         @default(0)
  
  // Timestamps
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  approvedAt          DateTime?
  
  @@index([status])
  @@index([registrationNumber])
  @@map("companies")
}

// ============================================
// PROMO CODE MODEL (Future feature)
// ============================================

enum PromoType {
  PERCENTAGE
  FIXED_AMOUNT
}

model PromoCode {
  id              String    @id @default(cuid())
  
  // Code details
  code            String    @unique
  description     String?
  
  // Discount details
  type            PromoType
  value           Float     // percentage or fixed amount
  maxDiscount     Float?    // max discount for percentage type
  minRideAmount   Float?    // minimum ride amount to use promo
  
  // Usage limits
  maxUsage        Int?      // total usage limit
  usageCount      Int       @default(0)
  maxUsagePerUser Int?      // per user limit
  
  // Validity
  isActive        Boolean   @default(true)
  validFrom       DateTime
  validUntil      DateTime
  
  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@index([code])
  @@index([isActive])
  @@map("promo_codes")
}

// ============================================
// NOTIFICATION MODEL (Future feature)
// ============================================

enum NotificationType {
  RIDE_REQUEST
  RIDE_ACCEPTED
  RIDE_ARRIVED
  RIDE_STARTED
  RIDE_COMPLETED
  RIDE_CANCELLED
  PAYMENT_RECEIVED
  RATING_RECEIVED
  PROMO_AVAILABLE
  SYSTEM_ALERT
}

model Notification {
  id        String           @id @default(cuid())
  
  // Recipient
  userId    String
  
  // Notification details
  type      NotificationType
  title     String
  message   String
  data      Json?            // Additional data (ride details, etc.)
  
  // Status
  isRead    Boolean          @default(false)
  readAt    DateTime?
  
  // Timestamps
  createdAt DateTime         @default(now())
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================
// ADMIN LOG MODEL (For audit trail)
// ============================================

enum AdminAction {
  APPROVE_RIDER
  REJECT_RIDER
  SUSPEND_RIDER
  ACTIVATE_RIDER
  SUSPEND_USER
  ACTIVATE_USER
  APPROVE_COMPANY
  REJECT_COMPANY
  UPDATE_PRICING
  CREATE_PROMO
  DELETE_PROMO
}

model AdminLog {
  id          String      @id @default(cuid())
  
  // Admin who performed action
  adminId     String
  
  // Action details
  action      AdminAction
  targetType  String      // "user", "rider", "company", etc.
  targetId    String
  description String?
  metadata    Json?       // Additional data about the action
  
  // Timestamp
  createdAt   DateTime    @default(now())
  
  @@index([adminId])
  @@index([action])
  @@index([createdAt])
  @@map("admin_logs")
}

// ============================================
// TRANSACTION MODEL (For Payment History)
// ============================================

enum TransactionType {
  DEPOSIT      // User deposits to wallet
  PAYMENT      // User pays for ride
  REFUND       // Refund to user
  WITHDRAWAL   // Rider withdraws earnings
  COMMISSION   // Platform commission
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Transaction {
  id        String            @id @default(cuid())
  
  // Related entities
  rideId    String?
  ride      Ride?             @relation(fields: [rideId], references: [id])
  userId    String
  user      User              @relation(fields: [userId], references: [id])
  
  // Transaction details
  amount    Float
  type      TransactionType
  status    TransactionStatus @default(PENDING)
  
  // Payment gateway info
  provider  String?           // 'paystack', 'flutterwave', 'cash', 'wallet', 'monnify'
  reference String?           @unique  // Payment reference from gateway
  
  // Additional info
  description String?
  metadata    Json?
  
  // Timestamps
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  
  @@index([userId])
  @@index([rideId])
  @@index([reference])
  @@index([status])
  @@index([createdAt])
  @@map("transactions")
}

// ============================================
// WALLET MODEL
// ============================================

model Wallet {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  balance   Float    @default(0)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
  @@map("wallets")
}